const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.es-DbhXdeax.js","assets/index-B3E2rKjL.js","assets/index-NAa81V-T.css"])))=>i.map(i=>d[i]);
import{g as V,a as D,N as k,n as P,b as T,s as J,_ as K,D as X,c as v,f as Y,d as L,e as B,h as I,p as Q,i as Z,v as H,j as x,k as O,u as nn,l as b,t as an}from"./index-B3E2rKjL.js";import{U as en,S as tn}from"./rpc-CKSI7MTo.js";let _=null;const U={lastUsedChainId:"tw.wc.lastUsedChainId",requestedChains:"tw.wc.requestedChains"};async function un(n,i,e,t,a){var g,N,q;const o=await W(n,e,a),d=n.walletConnect;let{onDisplayUri:c}=d||{};const s=await D(e);!c&&a&&(c=S=>{const R=s.mobile.native||s.mobile.universal;if(!R){a(S);return}const G=Y(R,S).redirect;a(G)}),c&&o.events.addListener("display_uri",c);let h=d==null?void 0:d.optionalChains,l=n.chain;e==="global.safe"&&(h=z.map(T),l&&!h.includes(l)&&(l=void 0));const{chains:f,rpcMap:r}=dn({chain:l,client:n.client,optionalChains:h});await o.connect({...d!=null&&d.pairingTopic?{pairingTopic:d==null?void 0:d.pairingTopic}:{},optionalNamespaces:{[k]:{chains:f,events:["chainChanged","accountsChanged"],methods:["eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign","eth_signTypedData","eth_signTypedData_v4","wallet_switchEthereumChain","wallet_addEthereumChain"],rpcMap:r}}}),F(f.map(E=>Number(E.split(":")[1])),t);const u=((g=f[0])==null?void 0:g.split(":")[1])||1,C=P(u),m=sn(o.session,"eip155:1");if(!m)throw new Error("No accounts found on provider.");const p=n.chain&&n.chain.id===C?n.chain:T(C);if(n){const E={chain:n.chain,optionalChains:(N=n.walletConnect)==null?void 0:N.optionalChains,pairingTopic:(q=n.walletConnect)==null?void 0:q.pairingTopic};t&&J(t,e,E)}return c&&o.events.removeListener("display_uri",c),$(m,p,o,i,t,n.client,s,a)}async function cn(n,i,e){var d,c,s,h,l,f;if(!n.session)throw new Error("No session found on provider.");const t=`eip155:${i.id}`,a=b(i.id);if(M(n.session,t)){n.setDefaultChain(t);return}try{await y({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:a}]},chain:t,walletInfo:e}),n.setDefaultChain(t);return}catch(r){if(((r==null?void 0:r.code)??((c=(d=r==null?void 0:r.data)==null?void 0:d.originalError)==null?void 0:c.code))===4001)throw new Error("User rejected chain switch")}const o=on(n.session);if(!o)throw new Error("No routable chain to send wallet_addEthereumChain");try{await y({provider:n,payload:{method:"wallet_addEthereumChain",params:[{chainId:a,chainName:i.name,nativeCurrency:i.nativeCurrency,rpcUrls:[i.rpc],blockExplorerUrls:[((h=(s=i.blockExplorers)==null?void 0:s[0])==null?void 0:h.url)??""]}]},chain:o,walletInfo:e})}catch(r){throw((r==null?void 0:r.code)??((f=(l=r==null?void 0:r.data)==null?void 0:l.originalError)==null?void 0:f.code))===4001?new Error("User rejected add chain"):new Error(`Add chain failed: ${(r==null?void 0:r.message)||String(r)}`)}if(await y({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:a}]},chain:t,walletInfo:e}),n.setDefaultChain(t),!M(n.session,t))throw new Error("Target chain still not enabled by wallet")}function A(n){var i;return(i=n==null?void 0:n.namespaces)==null?void 0:i.eip155}function M(n,i){var t;const e=A(n);return!!((t=e==null?void 0:e.accounts)!=null&&t.some(a=>a.startsWith(`${i}:`)))}function sn(n,i){var a;const e=A(n),t=((a=e==null?void 0:e.accounts)==null?void 0:a.find(o=>o.startsWith(`${i}:`)))||(e==null?void 0:e.accounts[0]);return t?t.split(":")[2]??null:null}function on(n){var e,t,a,o;const i=A(n);return((o=(a=(t=(e=i==null?void 0:i.accounts)==null?void 0:e[0])==null?void 0:t.split(":"))==null?void 0:a.slice(0,2))==null?void 0:o.join(":"))??null}async function fn(n,i,e,t,a){var u,C,w,m,p;const o=t?await V(t,e):null,d=await D(e),c=await W(o?{chain:o.chain,client:n.client,walletConnect:{optionalChains:o.optionalChains,pairingTopic:o.pairingTopic}}:{client:n.client,walletConnect:{}},e,a);if(!c.session)throw await c.disconnect(),new Error("No wallet connect session found on provider.");const s=(w=(C=(u=c.session)==null?void 0:u.namespaces)==null?void 0:C[k])==null?void 0:w.accounts,h=(m=s==null?void 0:s[0])==null?void 0:m.split(":")[2];if(!h)throw new Error("No accounts found on provider.");const l=((p=n.chain)==null?void 0:p.id)||1,f=P(l),r=n.chain&&n.chain.id===f?n.chain:T(f);return $(h,r,c,i,t,n.client,d,a)}async function W(n,i,e){var h,l,f,r;if(_)return _;const t=await D(i),a=n.walletConnect,{UniversalProvider:o}=await K(async()=>{const{UniversalProvider:u}=await import("./index.es-DbhXdeax.js");return{UniversalProvider:u}},__vite__mapDeps([0,1,2]));let d=a==null?void 0:a.optionalChains,c=n.chain;i==="global.safe"&&(d=z.map(T),c&&!d.includes(c)&&(c=void 0));const s=await o.init({metadata:{description:((h=a==null?void 0:a.appMetadata)==null?void 0:h.description)||v().description,icons:[((l=a==null?void 0:a.appMetadata)==null?void 0:l.logoUrl)||v().logoUrl],name:((f=a==null?void 0:a.appMetadata)==null?void 0:f.name)||v().name,url:((r=a==null?void 0:a.appMetadata)==null?void 0:r.url)||v().url,redirect:{native:t.mobile.native||void 0,universal:t.mobile.universal||void 0}},projectId:(a==null?void 0:a.projectId)||X});if(s.events.setMaxListeners(Number.POSITIVE_INFINITY),i!=="walletConnect"){async function u(){var w,m,p,g;const C=((g=(p=(m=(w=s.session)==null?void 0:w.peer)==null?void 0:m.metadata)==null?void 0:p.redirect)==null?void 0:g.native)||t.mobile.native||t.mobile.universal;e&&C&&await e(C)}s.on("session_request_sent",u),s.events.addListener("disconnect",()=>{s.off("session_request_sent",u),_=null})}return _=s,s}function j({provider:n,address:i,client:e,chain:t,sessionRequestHandler:a,walletInfo:o}){return{address:I(i),async sendTransaction(c){const s=await y({provider:n,payload:{method:"eth_sendTransaction",params:[{data:c.data,from:I(i),gas:c.gas?b(c.gas):void 0,to:c.to,value:c.value?b(c.value):void 0}]},chain:`eip155:${c.chainId}`,walletInfo:o,sessionRequestHandler:a});return an({chainId:c.chainId,client:e,contractAddress:c.to??void 0,gasPrice:c.gasPrice,transactionHash:s,walletAddress:I(i),walletType:"walletConnect"}),{transactionHash:s}},async signMessage({message:c}){const s=typeof c=="string"?O(c):c.raw instanceof Uint8Array?nn(c.raw):c.raw;return y({provider:n,payload:{method:"personal_sign",params:[s,this.address]},chain:`eip155:${t.id}`,walletInfo:o,sessionRequestHandler:a})},async signTypedData(c){const s=Q(c),{domain:h,message:l,primaryType:f}=s,r={EIP712Domain:Z({domain:h}),...s.types};H({domain:h,message:l,primaryType:f,types:r});const u=x({domain:h??{},message:l,primaryType:f,types:r});return await y({provider:n,payload:{method:"eth_signTypedData_v4",params:[this.address,u]},chain:`eip155:${t.id}`,walletInfo:o,sessionRequestHandler:a})}}}async function y(n){var s,h,l,f;const{provider:i,payload:e,chain:t,walletInfo:a,sessionRequestHandler:o}=n,d=i.request(e,t),c=((f=(l=(h=(s=i.session)==null?void 0:s.peer)==null?void 0:h.metadata)==null?void 0:l.redirect)==null?void 0:f.native)||a.mobile.native||a.mobile.universal;return o&&c&&await o(c),d}function $(n,i,e,t,a,o,d,c){const s=j({address:n,chain:i,client:o,provider:e,sessionRequestHandler:c,walletInfo:d});async function h(){e.removeListener("accountsChanged",f),e.removeListener("chainChanged",r),e.removeListener("disconnect",l),await e.disconnect(),_=null}function l(){F([],a),a==null||a.removeItem(U.lastUsedChainId),h(),t.emit("disconnect",void 0)}function f(u){if(u[0]){const C=j({address:I(u[0]),chain:i,client:o,provider:e,sessionRequestHandler:c,walletInfo:d});t.emit("accountChanged",C),t.emit("accountsChanged",u)}else l()}function r(u){const C=T(P(u));t.emit("chainChanged",C),a==null||a.setItem(U.lastUsedChainId,String(u))}return e.on("accountsChanged",f),e.on("chainChanged",r),e.on("disconnect",l),e.on("session_delete",l),[s,i,h,u=>rn(e,u,d)]}async function rn(n,i,e){try{await cn(n,i,e)}catch(t){const a=typeof t=="string"?t:t==null?void 0:t.message;throw/user rejected request/i.test(a)?new en(t):new tn(t)}}function F(n,i){i==null||i.setItem(U.requestedChains,B(n))}function dn(n){const i={},e=[];n.chain&&(i[n.chain.id]=L({chain:n.chain,client:n.client}),e.push(n.chain.id));const t=((n==null?void 0:n.optionalChains)||[]).slice(0,10);for(const a of t)i[a.id]=L({chain:a,client:n.client}),e.push(a.id);return e.includes(1)||(i[1]=T(1).rpc,e.push(1)),{chains:e.map(a=>`eip155:${a}`),rpcMap:i}}const z=[1,11155111,42161,43114,8453,1313161554,84532,56,42220,100,10,137,1101,324,534352];export{fn as autoConnectWC,un as connectWC};
